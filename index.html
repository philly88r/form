// --- Add Event Listener in DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', function() {
    // ... other listeners ...
    document.getElementById('downloadFormButton').addEventListener('click', downloadFormHtmlCss); // Add listener
    // ... rest of init ...
});


// --- NEW Download Function ---
function downloadFormHtmlCss() {
    console.log('Preparing form HTML/CSS for download...');

    if (!isAdminMode) {
        alert('Please enter Admin Mode first to access download.');
        return;
    }

    // 1. Temporarily hide admin controls for clean HTML capture
    const originalAdminMode = isAdminMode;
    isAdminMode = false; // Set mode to non-admin
    renderForm(); // Re-render WITHOUT admin buttons/edit inputs
    updateCalculatedFieldDisplay(); // Ensure calculated fields are up-to-date in the non-admin view

    // 2. Capture the clean form HTML
    const formContainer = document.getElementById('fenceCalculator');
    // Exclude the admin toggle button and the admin panel itself from the download
    const adminToggleButton = document.getElementById('toggleEditorMode');
    const adminPanelElement = document.getElementById('adminPanel');
    const originalToggleDisplay = adminToggleButton.style.display;
    const originalPanelDisplay = adminPanelElement.style.display;
    adminToggleButton.style.display = 'none'; // Hide button
    adminPanelElement.style.display = 'none'; // Hide panel
    const cleanFormHtml = formContainer.innerHTML; // Get HTML of container content
    adminToggleButton.style.display = originalToggleDisplay; // Restore button display
    adminPanelElement.style.display = originalPanelDisplay; // Restore panel display


    // 3. Restore admin mode and re-render
    isAdminMode = originalAdminMode; // Set mode back
    renderForm(); // Re-render WITH admin controls
    updateCalculatedFieldDisplay(); // Update calculated fields in admin view


    // 4. Get CSS content
    let cssContent = '';
    const styleElement = document.querySelector('style');
    if (styleElement) {
        cssContent = styleElement.textContent || styleElement.innerText;
    } else {
        console.warn('Could not find <style> tag to extract CSS.');
    }

    // 5. Create complete HTML content for download
    const fullHtmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Fence Calculator Form</title>
    <style>
${cssContent}
    </style>
</head>
<body>
    <div class="form-container" id="fenceCalculator">
        ${cleanFormHtml}
        <script>
            // Optional: Add basic JS needed for the standalone form?
            // For now, it's just the static HTML structure + CSS.
            // Calculation logic, dynamic fields etc. would NOT work
            // without including and adapting the main script.
            console.log("Static form loaded.");
        <\/script>
    </div>
</body>
</html>`;

    // 6. Create blob and trigger download
    const blob = new Blob([fullHtmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'fence_calculator_form.html'; // Filename
    document.body.appendChild(a); // Required for Firefox
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); // Clean up

    console.log('Download initiated.');
}