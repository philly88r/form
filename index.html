<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chainlink Fence Calculator</title>
    <style>
        /* ... (keep all existing styles from the previous version) ... */

        /* Add styles for arrow buttons */
        .action-button.move {
            color: #6b7280; /* Neutral color */
            font-size: 1.2em; /* Make arrows slightly larger */
            line-height: 1;
            padding: 1px 4px; /* Adjust padding */
            vertical-align: middle;
        }
        .action-button.move:hover:not(:disabled) {
            background-color: #e5e7eb;
            color: #374151;
        }
        .action-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .action-buttons-container {
            /* Ensure enough space for all buttons */
            white-space: nowrap;
             margin-left: auto; /* Push buttons to the right in flex container */
             padding-left: 10px; /* Space between label/input and buttons */
        }

        /* Style for calculated fields */
        .input-field.calculated-field {
            background-color: #e5e7eb; /* Light gray background */
            color: #4b5563; /* Darker text */
            cursor: not-allowed;
            font-weight: bold;
        }

         /* Ensure editable labels handle buttons correctly */
         .editable-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: nowrap; /* Prevent wrapping by default */
        }
         .editable-label > span:first-child,
         .editable-label > label:first-child,
         .editable-label > input:first-child {
             flex-grow: 1; /* Label/Input takes space */
             margin-right: 5px; /* Minimal space before buttons */
             min-width: 100px; /* Prevent label collapsing too much */
         }
         .post-group-title {
              display: flex; /* Make title container flex */
              align-items: center;
              justify-content: space-between; /* Push buttons to the end */
         }
          .post-group-title .action-buttons-container {
              margin-left: 10px; /* Space before buttons */
              flex-shrink: 0; /* Prevent buttons shrinking */
          }
           .post-field-item .editable-label .action-buttons-container {
               margin-left: 5px; /* Smaller margin for sub-field buttons */
           }

    </style>
</head>
<body>
    <!-- ... (keep existing HTML structure: form-container, admin panel, form) ... -->
     <div class="form-container" id="fenceCalculator">
        <h2 class="form-title">Chainlink Fence Calculator</h2>

        <button id="toggleEditorMode" class="admin-button" style="margin-bottom: 20px;">
            Enter Editor Mode
        </button>

        <div id="adminPanel" class="admin-controls-container" style="display: none;">
             <h3 class="admin-controls-title">Form Editor</h3>
             <button id="toggleAddQuestionForm" class="admin-button primary">
                 Add New Question
             </button>
             
             <!-- Add Download Button -->
             <button id="downloadFormButton" class="admin-button" style="background-color: #3b82f6; margin-left: 10px;">
                 Download Form HTML/CSS
             </button>

             <div id="addQuestionForm" class="add-question-form" style="display: none;">
                 <h4>Add New Question</h4>
                 <div class="question-form-field">
                     <label class="label">Question ID (unique identifier)<span class="required-indicator">*</span></label>
                     <input id="newQuestionId" type="text" class="input-field" placeholder="E.g., fenceHeight">
                 </div>

                 <div class="question-form-field">
                     <label class="label">Question Text<span class="required-indicator">*</span></label>
                     <input id="newQuestionText" type="text" class="input-field" placeholder="E.g., What is the fence height?">
                 </div>

                 <div class="question-form-field">
                     <label class="label">Input Type</label>
                     <select id="newQuestionInputType" class="select-dropdown">
                         <option value="text">Text</option>
                         <option value="number">Number</option>
                         <option value="select">Select (Dropdown)</option>
                     </select>
                 </div>

                 <div id="optionsField" class="question-form-field" style="display: none;">
                     <label class="label">Options (comma-separated)<span class="required-indicator">*</span></label>
                     <input id="newQuestionOptions" type="text" class="input-field" placeholder="E.g., Option 1, Option 2, Option 3">
                 </div>

                 <div class="question-form-field">
                     <label class="label">Section</label>
                     <select id="newQuestionSection" class="select-dropdown">
                         <!-- Dynamically populate sections later? Or keep static list -->
                         <option value="Basic Info">Basic Info</option>
                         <option value="Posts">Posts</option>
                         <option value="Gates">Gates</option>
                         <option value="Line Posts">Line Posts</option>
                         <option value="Extra Options">Extra Options</option>
                         <option value="Other">Other</option>
                     </select>
                 </div>

                 <div class="question-form-field">
                     <label class="label">Default Value (optional)</label>
                     <input id="newQuestionDefault" type="text" class="input-field" placeholder="Default value (if any)">
                 </div>

                 <div class="question-form-field">
                     <label class="label" style="display: inline-flex; align-items: center;">
                         <input id="newQuestionRequired" type="checkbox" style="margin-right: 8px; transform: scale(1.1);">
                         Required Field
                     </label>
                 </div>

                 <div class="question-form-field">
                    <label class="label">
                        <input id="newQuestionCalculated" type="checkbox" style="margin-right: 8px; transform: scale(1.1);">
                        Calculated Field (Read-Only)
                    </label>
                </div>

                 <div class="question-form-field">
                    <label class="label">Dependency: Only show if Question ID</label>
                    <input id="newQuestionDependentOn" type="text" class="input-field" placeholder="e.g., includeBarbedWire">
                </div>
                <div class="question-form-field">
                    <label class="label">Has the value</label>
                    <input id="newQuestionDependentValue" type="text" class="input-field" placeholder="e.g., Yes">
                </div>

                 <div class="question-form-field">
                     <label class="label">Display Order</label>
                     <input id="newQuestionOrder" type="number" value="999" class="input-field">
                 </div>

                 <button id="addQuestionButton" class="admin-button success">
                     Add Question
                 </button>
                  <button id="cancelAddQuestionButton" type="button" class="admin-button" style="background-color: #6b7280;">
                     Cancel
                 </button>
             </div>
         </div>

        <form id="fenceCalculatorForm">
            <div id="formSections"></div>
            <button type="submit" class="submit-button">Calculate Material List / Cost</button>
        </form>
    </div>

    <script>
        // --- Configuration ---
        const initialChainlinkFenceQuestions = [
            // --- Basic Info Section ---
            {
                id: 'numberOfPulls',
                question_text: 'Number of Fence Pulls/Sections',
                input_type: 'number',
                default: '2',
                required: true,
                section: 'Basic Info',
                order: 10,
                dynamic_fields: {
                    container_id_prefix: 'dynamic-pulls-',
                    container_class: 'dynamic-fields-container',
                    title: 'Fence Pull/Section Lengths',
                    grid_class: 'dynamic-fields-grid',
                    item_class: 'dynamic-field-item',
                    template: {
                        id_template: 'pull{n}Length',
                        text_template: 'Length of Pull/Section {n} (ft)',
                        input_type: 'number',
                        placeholder: 'Enter length',
                        required: true,
                        style: { labelColor: '#1e40af', borderColor: '#3b82f6' }
                    }
                }
            },
            {
                id: 'totalFootage',
                question_text: 'Total Linear Length (ft)',
                input_type: 'number',
                required: true,
                calculated: true, // Mark as calculated
                section: 'Basic Info',
                order: 20
            },
            {
                id: 'fenceHeight',
                question_text: 'Height of Fence (ft)',
                input_type: 'number', // Changed to number
                default: '4',
                required: true,
                section: 'Basic Info',
                order: 30
            },
            {
                id: 'commercialOrResidential',
                question_text: 'Project Type',
                input_type: 'select',
                options: ['Commercial', 'Residential'],
                default: 'Commercial',
                required: true,
                section: 'Basic Info',
                order: 40
            },
            {
                id: 'fenceMaterial',
                question_text: 'Fence Material Color',
                input_type: 'select',
                options: ['Galv', 'Black'],
                default: 'Galv',
                required: true,
                section: 'Basic Info',
                order: 50
            },
            {
                id: 'meshGauge',
                question_text: 'Mesh Gauge/Type',
                input_type: 'select',
                options: ['Residential 11.5 gauge', 'Commercial 9 gauge', 'Residential 9 gauge', 'Commercial 8 gauge'],
                default: 'Residential 11.5 gauge',
                required: true,
                section: 'Basic Info',
                order: 60
            },
            {
                id: 'meshFoldType',
                question_text: 'Mesh Fold Type',
                input_type: 'select',
                options: ['KK', 'KT'],
                default: 'KK',
                required: true,
                section: 'Basic Info',
                order: 70
            },
            // --- Gates Section ---
            {
                id: 'numberOfSingleGates',
                question_text: 'Number of Single Gates',
                input_type: 'number',
                default: '0',
                required: true,
                section: 'Gates',
                order: 200,
                dynamic_fields: {
                    type: 'gate', gate_type: 'single', container_id_prefix: 'gate-fields-single-',
                    container_class: 'gate-fields-container', title_template: 'Single Gate {n} Specifications',
                    grid_class: 'gate-fields-grid', item_class: 'gate-field-item',
                    post_container_class: 'gate-posts-container', post_title_template: 'Gate {n} Post Details', post_grid_class: 'gate-fields-grid',
                    template: {
                        fields: [
                            { id_template: 'singleGate{n}Width', text_template: 'Width (ft)', input_type: 'number', required: true, order: 1 },
                            { id_template: 'singleGate{n}Height', text_template: 'Height (ft)', input_type: 'number', required: true, order: 2 },
                            { id_template: 'singleGate{n}FrameType', text_template: 'Frame Type', input_type: 'select', options: ['1 5/8', '2'], required: true, order: 3 },
                            { id_template: 'singleGate{n}LatchType', text_template: 'Latch Type', input_type: 'select', options: ['Fork', 'Fork Single', 'Industrial Swing'], required: true, order: 4 }
                        ],
                        post_fields: [
                            { id_template: 'singleGate{n}PostDiameter', text_template: 'Post Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 101 },
                            { id_template: 'singleGate{n}PostThickness', text_template: 'Post Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 102 },
                            { id_template: 'singleGate{n}PostHoleDepth', text_template: 'Post Hole Depth (in)', input_type: 'number', required: true, order: 103 },
                            { id_template: 'singleGate{n}PostHoleWidth', text_template: 'Post Hole Width (in)', input_type: 'number', required: true, order: 104 }
                        ],
                        style: { labelColor: '#047857', borderColor: '#10b981', postLabelColor: '#3f6212', postBorderColor: '#84cc16' }
                    }
                }
            },
            {
                id: 'numberOfDoubleGates',
                question_text: 'Number of Double Gates',
                input_type: 'number',
                default: '0',
                required: true,
                section: 'Gates',
                order: 210,
                dynamic_fields: {
                    type: 'gate', gate_type: 'double', container_id_prefix: 'gate-fields-double-',
                    container_class: 'gate-fields-container', title_template: 'Double Gate {n} Specifications',
                    grid_class: 'gate-fields-grid', item_class: 'gate-field-item',
                    post_container_class: 'gate-posts-container', post_title_template: 'Gate {n} Post Details', post_grid_class: 'gate-fields-grid',
                    template: {
                        fields: [
                            { id_template: 'doubleGate{n}Width', text_template: 'Width (ft)', input_type: 'number', required: true, order: 1 },
                            { id_template: 'doubleGate{n}Height', text_template: 'Height (ft)', input_type: 'number', required: true, order: 2 },
                            { id_template: 'doubleGate{n}FrameType', text_template: 'Frame Type', input_type: 'select', options: ['1 5/8', '2'], required: true, order: 3 },
                            { id_template: 'doubleGate{n}LatchType', text_template: 'Latch Type', input_type: 'select', options: ['Fork', 'Fork Single', 'Industrial Swing'], required: true, order: 4 }
                        ],
                        post_fields: [
                            { id_template: 'doubleGate{n}PostDiameter', text_template: 'Post Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 101 },
                            { id_template: 'doubleGate{n}PostThickness', text_template: 'Post Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 102 },
                            { id_template: 'doubleGate{n}PostHoleDepth', text_template: 'Post Hole Depth (in)', input_type: 'number', required: true, order: 103 },
                            { id_template: 'doubleGate{n}PostHoleWidth', text_template: 'Post Hole Width (in)', input_type: 'number', required: true, order: 104 }
                        ],
                        style: { labelColor: '#7e22ce', borderColor: '#a855f7', postLabelColor: '#3f6212', postBorderColor: '#84cc16' }
                    }
                }
            },
            {
                id: 'numberOfSlidingGates',
                question_text: 'Number of Sliding Gates',
                input_type: 'number',
                default: '0',
                required: true,
                section: 'Gates',
                order: 220,
                dynamic_fields: {
                    type: 'gate', gate_type: 'sliding', container_id_prefix: 'gate-fields-sliding-',
                    container_class: 'gate-fields-container', title_template: 'Sliding Gate {n} Specifications',
                    grid_class: 'gate-fields-grid', item_class: 'gate-field-item',
                    post_container_class: 'gate-posts-container', post_title_template: 'Gate {n} Post Details', post_grid_class: 'gate-fields-grid',
                    template: {
                        fields: [
                            { id_template: 'slidingGate{n}Width', text_template: 'Width (ft)', input_type: 'number', required: true, order: 1 },
                            { id_template: 'slidingGate{n}Height', text_template: 'Height (ft)', input_type: 'number', required: true, order: 2 },
                            { id_template: 'slidingGate{n}FrameType', text_template: 'Frame Type', input_type: 'select', options: ['1 5/8', '2'], required: true, order: 3 },
                            { id_template: 'slidingGate{n}TrackType', text_template: 'Track Type', input_type: 'select', options: ['V-Track', 'Cantilever'], required: true, order: 4 }
                        ],
                        post_fields: [
                            { id_template: 'slidingGate{n}PostDiameter', text_template: 'Post Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 101 },
                            { id_template: 'slidingGate{n}PostThickness', text_template: 'Post Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 102 },
                            { id_template: 'slidingGate{n}PostHoleDepth', text_template: 'Post Hole Depth (in)', input_type: 'number', required: true, order: 103 },
                            { id_template: 'slidingGate{n}PostHoleWidth', text_template: 'Post Hole Width (in)', input_type: 'number', required: true, order: 104 }
                        ],
                        style: { labelColor: '#b45309', borderColor: '#f59e0b', postLabelColor: '#3f6212', postBorderColor: '#84cc16' }
                    }
                }
            },
            // --- Posts Section ---
            {
                id: 'useFlangedPosts',
                question_text: 'Use Flanged Posts?',
                input_type: 'select',
                options: ['Yes', 'No'],
                default: 'No',
                required: true,
                section: 'Posts',
                order: 100
            },
            { // Terminal Posts Group
                id: 'terminalPostGroup',
                question_text: 'Terminal Posts',
                is_post_group: true,
                section: 'Posts',
                order: 110,
                post_group_questions: [
                    { id: 'numTerminalPosts', question_text: 'Number of Posts', input_type: 'number', required: true, order: 1 },
                    { id: 'terminalPostDiameter', question_text: 'Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 2 },
                    { id: 'terminalPostThickness', question_text: 'Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 3 },
                    { id: 'terminalPostHoleDepth', question_text: 'Hole Depth (in)', input_type: 'number', required: true, order: 4 },
                    { id: 'terminalPostHoleWidth', question_text: 'Hole Width (in)', input_type: 'number', required: true, order: 5 }
                ]
            },
            { // Corner Posts Group
                id: 'cornerPostGroup',
                question_text: 'Corner Posts',
                is_post_group: true,
                section: 'Posts',
                order: 120,
                post_group_questions: [
                    { id: 'numCornerPosts', question_text: 'Number of Posts', input_type: 'number', required: true, order: 1 },
                    { id: 'cornerPostDiameter', question_text: 'Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 2 },
                    { id: 'cornerPostThickness', question_text: 'Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 3 },
                    { id: 'cornerPostHoleDepth', question_text: 'Hole Depth (in)', input_type: 'number', required: true, order: 4 },
                    { id: 'cornerPostHoleWidth', question_text: 'Hole Width (in)', input_type: 'number', required: true, order: 5 }
                ]
            },
            { // Flanged Posts Centered Group
                id: 'flangedPostCenteredGroup',
                question_text: 'Flanged Posts - Centered',
                is_post_group: true,
                section: 'Posts',
                order: 130,
                dependent_on: 'useFlangedPosts', // Dependency
                dependent_value: 'Yes',         // Dependency
                post_group_questions: [
                    { id: 'numFlangedPostsCentered', question_text: 'Number of Posts', input_type: 'number', required: true, order: 1 },
                    { id: 'flangedPostCenteredDiameter', question_text: 'Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 2 },
                    { id: 'flangedPostCenteredThickness', question_text: 'Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 3 },
                    { id: 'flangedPostCenteredHoleDepth', question_text: 'Hole Depth (in)', input_type: 'number', required: true, order: 4 },
                    { id: 'flangedPostCenteredHoleWidth', question_text: 'Hole Width (in)', input_type: 'number', required: true, order: 5 }
                ]
            },
            { // Flanged Posts Off Centered Group
                id: 'flangedPostOffCenteredGroup',
                question_text: 'Flanged Posts - Off Centered',
                is_post_group: true,
                section: 'Posts',
                order: 140,
                dependent_on: 'useFlangedPosts', // Dependency
                dependent_value: 'Yes',         // Dependency
                post_group_questions: [
                    { id: 'numFlangedPostsOffCentered', question_text: 'Number of Posts', input_type: 'number', required: true, order: 1 },
                    { id: 'flangedPostOffCenteredDiameter', question_text: 'Diameter', input_type: 'select', options: ['2 3/8', '2 7/8', '4', '6 5/8'], required: true, order: 2 },
                    { id: 'flangedPostOffCenteredThickness', question_text: 'Thickness', input_type: 'select', options: ['SCH 40', 'Commercial SCH 40', 'Industrial SCH 40'], required: true, order: 3 },
                    { id: 'flangedPostOffCenteredHoleDepth', question_text: 'Hole Depth (in)', input_type: 'number', required: true, order: 4 },
                    { id: 'flangedPostOffCenteredHoleWidth', question_text: 'Hole Width (in)', input_type: 'number', required: true, order: 5 }
                ]
            },
            // --- Line Posts Section ---
            {
                id: 'linePostSpacing',
                question_text: 'Line Post Spacing (ft)',
                input_type: 'number',
                default: '10',
                required: true,
                section: 'Line Posts',
                order: 300
            },
            { // Line Posts Group
                id: 'linePostGroup',
                question_text: 'Line Posts',
                is_post_group: true,
                section: 'Line Posts',
                order: 310,
                post_group_questions: [
                    { id: 'numLinePosts', question_text: 'Number of Posts', input_type: 'number', required: true, calculated: true, order: 1 },
                    { id: 'linePostDiameter', question_text: 'Diameter', input_type: 'select', options: ['1 5/8', '2', '2 3/8', '2 7/8'], required: true, order: 2 },
                    { id: 'linePostThickness', question_text: 'Thickness', input_type: 'select', options: ['SCH 20', 'SCH 40', 'Commercial SCH 40'], required: true, order: 3 },
                    { id: 'linePostHoleDepth', question_text: 'Hole Depth (in)', input_type: 'number', required: true, order: 4 },
                    { id: 'linePostHoleWidth', question_text: 'Hole Width (in)', input_type: 'number', required: true, order: 5 }
                ]
            },
            // --- Extra Options Section ---
            {
                id: 'topRail',
                question_text: 'Top Rail',
                input_type: 'select',
                options: ['1 5/8', '1 5/8 Heavy Wall'],
                default: '1 5/8',
                required: true,
                section: 'Extra Options',
                order: 400
            },
            {
                id: 'midRail',
                question_text: 'Mid Rail',
                input_type: 'select',
                options: ['None', '1 5/8', '1 5/8 Heavy Wall'],
                default: 'None',
                required: true,
                section: 'Extra Options',
                order: 410
            },
            {
                id: 'bottomRail',
                question_text: 'Bottom Rail',
                input_type: 'select',
                options: ['None', '1 5/8', '1 5/8 Heavy Wall'],
                default: 'None',
                required: true,
                section: 'Extra Options',
                order: 420
            },
            {
                id: 'barbedWire',
                question_text: 'Barbed Wire',
                input_type: 'select',
                options: ['None', '3 Strand', '6 Strand'],
                default: 'None',
                required: true,
                section: 'Extra Options',
                order: 430
            },
            {
                id: 'barbedWireType',
                question_text: 'Barbed Wire Type',
                input_type: 'select',
                options: ['2pt Galv', '4pt Galv', '2pt Black', '4pt Black'],
                default: '2pt Galv',
                required: true,
                section: 'Extra Options',
                order: 440,
                dependent_on: 'barbedWire',
                dependent_value: ['3 Strand', '6 Strand']
            },
            {
                id: 'barbedWireArms',
                question_text: 'Barbed Wire Arms',
                input_type: 'select',
                options: ['Straight', '45° In', '45° Out', 'Vertical'],
                default: 'Straight',
                required: true,
                section: 'Extra Options',
                order: 450,
                dependent_on: 'barbedWire',
                dependent_value: ['3 Strand', '6 Strand']
            },
            {
                id: 'privacySlats',
                question_text: 'Privacy Slats',
                input_type: 'select',
                options: ['None', 'PVC', 'Aluminum'],
                default: 'None',
                required: true,
                section: 'Extra Options',
                order: 460
            },
            {
                id: 'privacySlatsColor',
                question_text: 'Privacy Slats Color',
                input_type: 'select',
                options: ['White', 'Green', 'Brown', 'Black', 'Beige', 'Gray', 'Redwood'],
                default: 'Green',
                required: true,
                section: 'Extra Options',
                order: 470,
                dependent_on: 'privacySlats',
                dependent_value: ['PVC', 'Aluminum']
            }
        ];

        // --- State Variables ---
        let questions = JSON.parse(JSON.stringify(initialChainlinkFenceQuestions));
        let isAdminMode = false;
        let editingQuestionId = null;
        let showAddQuestionForm = false;
        let answers = {};
        let dynamicFieldStructures = { pulls: [], singleGates: [], doubleGates: [], slidingGates: [] };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('toggleEditorMode').addEventListener('click', toggleEditorMode);
            document.getElementById('toggleAddQuestionForm').addEventListener('click', toggleAddQuestionFormUI);
            document.getElementById('addQuestionButton').addEventListener('click', handleAddQuestion);
            document.getElementById('cancelAddQuestionButton').addEventListener('click', () => toggleAddQuestionFormUI(false));
            document.getElementById('newQuestionInputType').addEventListener('change', toggleOptionsField);
            document.getElementById('newQuestionCalculated').addEventListener('change', toggleCalculatedFieldOptions);
            document.getElementById('fenceCalculatorForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('downloadFormButton').addEventListener('click', downloadFormHtmlCss);

            initializeFormState();
            renderForm();
            recalculateAndUpdateFields();
        });

        // --- Core Functions ---
        // ... all your existing functions ...

        // --- NEW Download Function ---
        function downloadFormHtmlCss() {
            console.log('Preparing form HTML/CSS for download...');

            if (!isAdminMode) {
                alert('Please enter Admin Mode first to access download.');
                return;
            }

            // 1. Temporarily hide admin controls for clean HTML capture
            const originalAdminMode = isAdminMode;
            isAdminMode = false; // Set mode to non-admin
            renderForm(); // Re-render WITHOUT admin buttons/edit inputs
            updateCalculatedFieldDisplay(); // Ensure calculated fields are up-to-date in the non-admin view

            // 2. Capture the clean form HTML
            const formContainer = document.getElementById('fenceCalculator');
            // Exclude the admin toggle button and the admin panel itself from the download
            const adminToggleButton = document.getElementById('toggleEditorMode');
            const adminPanelElement = document.getElementById('adminPanel');
            const originalToggleDisplay = adminToggleButton.style.display;
            const originalPanelDisplay = adminPanelElement.style.display;
            adminToggleButton.style.display = 'none'; // Hide button
            adminPanelElement.style.display = 'none'; // Hide panel
            const cleanFormHtml = formContainer.innerHTML; // Get HTML of container content
            adminToggleButton.style.display = originalToggleDisplay; // Restore button display
            adminPanelElement.style.display = originalPanelDisplay; // Restore panel display

            // 3. Restore admin mode and re-render
            isAdminMode = originalAdminMode; // Set mode back
            renderForm(); // Re-render WITH admin controls
            updateCalculatedFieldDisplay(); // Update calculated fields in admin view

            // 4. Get CSS content
            let cssContent = '';
            const styleElement = document.querySelector('style');
            if (styleElement) {
                cssContent = styleElement.textContent || styleElement.innerText;
            } else {
                console.warn('Could not find <style> tag to extract CSS.');
            }

            // 5. Create complete HTML content for download
            const fullHtmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Fence Calculator Form</title>
    <style>
${cssContent}
    </style>
</head>
<body>
    <div class="form-container" id="fenceCalculator">
        ${cleanFormHtml}
        <script>
            // Optional: Add basic JS needed for the standalone form?
            // For now, it's just the static HTML structure + CSS.
            // Calculation logic, dynamic fields etc. would NOT work
            // without including and adapting the main script.
            console.log("Static form loaded.");
        <\/script>
    </div>
</body>
</html>`;

            // 6. Create blob and trigger download
            const blob = new Blob([fullHtmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fence_calculator_form.html'; // Filename
            document.body.appendChild(a); // Required for Firefox
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up

            console.log('Download initiated.');
        }

        function getSections() {
            const sections = {};
            const sectionOrderMap = {}; // To store the first encountered order for a section
            const sectionNames = new Set(); // To get unique section names

            // Process main questions and group titles
            questions.forEach(question => {
                const section = question.section || 'Other';
                sectionNames.add(section);
                if (!sections[section]) {
                    sections[section] = [];
                    // Store the order of the first item found for this section for sorting sections later
                    sectionOrderMap[section] = question.order ?? 9999;
                }
                sections[section].push(question);
            });

            // Define explicit order, falling back to discovered order
            const explicitSectionOrder = ['Basic Info', 'Gates', 'Posts', 'Line Posts', 'Extra Options', 'Other'];
            const sortedSectionNames = Array.from(sectionNames).sort((a, b) => {
                const indexA = explicitSectionOrder.indexOf(a);
                const indexB = explicitSectionOrder.indexOf(b);

                if (indexA !== -1 && indexB !== -1) return indexA - indexB; // Both explicitly ordered
                if (indexA !== -1) return -1; // A is explicit, B is not
                if (indexB !== -1) return 1; // B is explicit, A is not

                // Neither is explicitly ordered, sort by the order of their first question
                return (sectionOrderMap[a] ?? 9999) - (sectionOrderMap[b] ?? 9999);
            });

            return { sections, sortedSectionNames };
        }

        function renderForm() {
            // Renders all form sections and questions dynamically
            const formSections = document.getElementById('formSections');
            formSections.innerHTML = '';
            const { sections, sortedSectionNames } = getSections();
            sortedSectionNames.forEach(sectionName => {
                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'form-section';
                const sectionTitle = document.createElement('h3');
                sectionTitle.className = 'section-title';
                sectionTitle.textContent = sectionName;
                sectionContainer.appendChild(sectionTitle);
                sections[sectionName].forEach(question => {
                    if (!question.is_post_group) {
                        const questionElem = renderQuestion(question);
                        sectionContainer.appendChild(questionElem);
                    } else {
                        // Render post group
                        sectionContainer.appendChild(renderPostGroup(question));
                    }
                });
                formSections.appendChild(sectionContainer);
            });
            // Render dynamic fields if present
            renderDynamicSection(formSections);
        }

        function renderQuestion(question) {
            const wrapper = document.createElement('div');
            wrapper.className = 'question-wrapper';
            const label = createLabelElement(question);
            const input = createInputElement(question);
            wrapper.appendChild(label);
            wrapper.appendChild(input);

            if (isAdminMode) {
                const actionButtons = createAdminActionButtons(question.id, questions.findIndex(q => q.id === question.id), questions.length, questions, handleDeleteQuestion, handleEditQuestion, handleMoveQuestion);
                wrapper.appendChild(actionButtons);
            }

            return wrapper;
        }

        function renderPostGroup(question) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'post-group';
            const groupTitle = document.createElement('div');
            groupTitle.className = 'post-group-title';
            groupTitle.textContent = question.question_text;
            groupDiv.appendChild(groupTitle);

            if (isAdminMode) {
                const actionButtons = createAdminActionButtons(question.id, questions.findIndex(q => q.id === question.id), questions.length, questions, handleDeleteQuestion, handleEditQuestion, handleMoveQuestion);
                groupTitle.appendChild(actionButtons);
            }

            (question.post_group_questions || []).forEach(subQ => {
                const subElem = renderQuestion(subQ);
                subElem.classList.add('post-field-item');
                groupDiv.appendChild(subElem);
            });
            return groupDiv;
        }

        function createInputElement(question) {
            const input = document.createElement('input');
            input.className = 'input-field';
            input.type = question.input_type || 'text';
            input.id = question.id;
            input.value = answers[question.id] || '';
            input.required = !!question.required;
            input.disabled = !!question.calculated;
            input.addEventListener('input', e => handleChange(question.id, e.target.value));
            return input;
        }

        function createLabelElement(question) {
            const label = document.createElement('label');
            label.className = 'label';
            label.htmlFor = question.id;
            label.textContent = question.question_text;
            if (question.required) {
                const req = document.createElement('span');
                req.className = 'required-indicator';
                req.textContent = '*';
                label.appendChild(req);
            }
            return label;
        }

        function renderDynamicSection(formSections) {
            // Example: render dynamic fields for pulls, gates, etc.
            // (You can expand this as needed for your use case)
        }

        function initializeFormState() {
            console.log('Initializing form state...');
            answers = {};
            dynamicFieldStructures = { pulls: [], singleGates: [], doubleGates: [], slidingGates: [] };

            let maxOrder = 0;
            const assignOrder = (item) => {
                if (item.order === undefined || item.order === null) {
                    item.order = 9999;
                }
                if (!isNaN(item.order) && item.order > maxOrder) maxOrder = item.order;
            };

            questions.forEach(q => {
                assignOrder(q);
                if (q.is_post_group && q.post_group_questions) {
                    q.post_group_questions.forEach(assignOrder);
                }
            });

            questions.forEach(q => {
                if (q.default !== undefined) {
                    answers[q.id] = q.default;
                }
                if (q.dynamic_fields) {
                    const count = parseInt(answers[q.id] || '0', 10);
                    if (!isNaN(count) && count >= 0) { // Allow 0 count
                        updateDynamicFields(q.id, count);
                    }
                }
                // Init answers for post group sub-questions
                if (q.is_post_group && q.post_group_questions) {
                    q.post_group_questions.forEach(subQ => {
                        if (subQ.default !== undefined) {
                            answers[subQ.id] = subQ.default;
                        }
                    });
                }
            });

            // Recalculate after defaults are set
            recalculateAndUpdateFields();
            console.log('Initial answers:', answers);
        }

        function handleChange(id, value) {
            // Your existing handleChange function
        }

        function recalculateAndUpdateFields() {
            // Your existing recalculateAndUpdateFields function
        }

        function updateCalculatedFieldDisplay(specificId = null) {
            // Your existing updateCalculatedFieldDisplay function
        }

        function handleFormSubmit(event) {
            // Your existing handleFormSubmit function
        }

        function toggleEditorMode() {
            isAdminMode = !isAdminMode;
            document.getElementById('adminPanel').style.display = isAdminMode ? 'block' : 'none';
            document.getElementById('toggleEditorMode').textContent = isAdminMode ? 'Exit Editor Mode' : 'Enter Editor Mode';
            if (!isAdminMode) {
                toggleAddQuestionFormUI(false);
                editingQuestionId = null;
            }
            renderForm();
        }

        function toggleAddQuestionFormUI(forceState = null) {
            showAddQuestionForm = forceState !== null ? forceState : !showAddQuestionForm;
            const addQuestionForm = document.getElementById('addQuestionForm');
            const toggleButton = document.getElementById('toggleAddQuestionForm');

            addQuestionForm.style.display = showAddQuestionForm ? 'block' : 'none';
            toggleButton.textContent = showAddQuestionForm ? 'Cancel Adding Question' : 'Add New Question';
            toggleButton.className = showAddQuestionForm ? 'admin-button danger' : 'admin-button primary';

            if (showAddQuestionForm) {
                addQuestionForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Reset form fields
                document.getElementById('newQuestionId').value = '';
                document.getElementById('newQuestionText').value = '';
                document.getElementById('newQuestionInputType').value = 'text';
                document.getElementById('newQuestionSection').value = 'Basic Info';
                document.getElementById('newQuestionDefault').value = '';
                document.getElementById('newQuestionRequired').checked = false;
                document.getElementById('newQuestionCalculated').checked = false;
                document.getElementById('newQuestionDependentOn').value = '';
                document.getElementById('newQuestionDependentValue').value = '';
                document.getElementById('newQuestionOrder').value = '999';
                document.getElementById('newQuestionOptions').value = '';
                document.getElementById('optionsField').style.display = 'none';
                toggleCalculatedFieldOptions(); // Reset calculated fields UI
            }
        }

        function handleAddQuestion() {
            const id = document.getElementById('newQuestionId').value.trim();
            const questionText = document.getElementById('newQuestionText').value.trim();
            const inputType = document.getElementById('newQuestionInputType').value;
            const section = document.getElementById('newQuestionSection').value;
            const defaultValue = document.getElementById('newQuestionDefault').value.trim();
            const required = document.getElementById('newQuestionRequired').checked;
            const calculated = document.getElementById('newQuestionCalculated').checked;
            const order = parseInt(document.getElementById('newQuestionOrder').value, 10) || 999;
            const optionsString = document.getElementById('newQuestionOptions').value.trim();
            const dependentOn = document.getElementById('newQuestionDependentOn').value.trim();
            const dependentValue = document.getElementById('newQuestionDependentValue').value.trim();

            if (!id || !questionText) {
                alert('Question ID and Question Text are required.');
                return;
            }
            
            // Simple check for duplicate IDs
            if (questions.some(q => q.id === id)) {
                alert('A question with this ID already exists. Please use a unique ID.');
                return;
            }

            const newQuestion = { id, question_text: questionText, input_type: inputType, section, required, order };

            if (calculated) newQuestion.calculated = true;
            if (defaultValue) newQuestion.default = defaultValue;
            if (dependentOn && dependentValue) {
                newQuestion.dependent_on = dependentOn;
                newQuestion.dependent_value = dependentValue;
            }

            if (inputType === 'select') {
                const options = optionsString.split(',').map(opt => opt.trim()).filter(opt => opt !== '');
                if (options.length === 0) {
                    alert('Please provide at least one option for the select field (comma-separated).');
                    return;
                }
                newQuestion.options = options;
            }

            questions.push(newQuestion);
            console.log('Added new question:', newQuestion);
            toggleAddQuestionFormUI(false);
            initializeFormState();
            renderForm();
        }

        function updateDynamicFields(triggerQuestionId, count) {
            const question = questions.find(q => q.id === triggerQuestionId);
            if (!question || !question.dynamic_fields) return;
            const config = question.dynamic_fields;

            if (config.type === 'gate') {
                dynamicFieldStructures[`${config.gate_type}Gates`] = generateGateFieldStructures(config, count);
            } else {
                dynamicFieldStructures.pulls = generatePullFieldStructures(config, count);
            }
            cleanupOrphanedAnswers(triggerQuestionId, count);
        }

        function generatePullFieldStructures(config, count) {
            const newFields = [];
            const template = config.template;
            for (let i = 1; i <= count; i++) {
                const nStr = i.toString();
                newFields.push({
                    id: template.id_template.replace('{n}', nStr),
                    question_text: template.text_template.replace('{n}', nStr),
                    input_type: template.input_type || 'number',
                    required: template.required || false,
                    placeholder: template.placeholder,
                    is_dynamic_part: true,
                    trigger_id: triggerIdFromConfig(config),
                    order: i,
                    style: template.style
                });
            }
            console.log(`Generated ${newFields.length} pull field structures.`);
            return newFields;
        }

        function generateGateFieldStructures(config, count) {
            const newGateGroups = [];
            const template = config.template;
            const triggerId = triggerIdFromConfig(config);
            for (let i = 1; i <= count; i++) {
                const nStr = i.toString();
                const currentGateFields = [];
                (template.fields || []).forEach((fieldTmpl, index) => {
                    currentGateFields.push({
                        id: fieldTmpl.id_template.replace('{n}', nStr),
                        question_text: fieldTmpl.text_template.replace('{n}', nStr),
                        input_type: fieldTmpl.input_type || 'number',
                        options: fieldTmpl.options, 
                        default: fieldTmpl.default,
                        required: fieldTmpl.required || false, 
                        is_post_field: false,
                        is_dynamic_part: true, 
                        trigger_id: triggerId, 
                        gate_number: i,
                        order: fieldTmpl.order ?? index, 
                        style: template.style
                    });
                });
                (template.post_fields || []).forEach((fieldTmpl, index) => {
                    currentGateFields.push({
                        id: fieldTmpl.id_template.replace('{n}', nStr),
                        question_text: fieldTmpl.text_template.replace('{n}', nStr),
                        input_type: fieldTmpl.input_type || 'number',
                        options: fieldTmpl.options, 
                        default: fieldTmpl.default,
                        required: fieldTmpl.required || false, 
                        is_post_field: true,
                        is_dynamic_part: true, 
                        trigger_id: triggerId, 
                        gate_number: i,
                        order: fieldTmpl.order ?? (100 + index), 
                        style: template.style
                    });
                });
                // Sort fields within the gate group
                currentGateFields.sort((a, b) => (a.order ?? 9999) - (b.order ?? 9999));
                newGateGroups.push(currentGateFields);
            }
            console.log(`Generated ${newGateGroups.length} ${config.gate_type} gate groups structures.`);
            return newGateGroups;
        }

        function cleanupOrphanedAnswers(triggerQuestionId, count) {
            // Determine prefix based on trigger ID (e.g., 'numberOfPulls' -> 'pull', 'numberOfSingleGates' -> 'singleGate')
            let prefix = triggerQuestionId.replace('numberOf', '');
            if (prefix.endsWith('s')) prefix = prefix.slice(0, -1); // Remove trailing 's'
            prefix = prefix.charAt(0).toLowerCase() + prefix.slice(1); // Make first letter lowercase

            // Regex needs to match the prefix, the number, and then the rest of the ID
            const regex = new RegExp(`^${prefix}(\\d+)([A-Z].*|Length)$`);

            Object.keys(answers).forEach(key => {
                const match = key.match(regex);
                if (match && match[1]) {
                    const fieldNumber = parseInt(match[1], 10);
                    if (fieldNumber > count) {
                        console.log(`Cleaning up orphaned answer: ${key}`);
                        delete answers[key];
                    }
                }
            });
        }

        function getAllQuestionsIncludingDynamic() {
            const dynamicFields = [
                ...dynamicFieldStructures.pulls, 
                ...dynamicFieldStructures.singleGates.flat(),
                ...dynamicFieldStructures.doubleGates.flat(), 
                ...dynamicFieldStructures.slidingGates.flat()
            ];
            const postGroupSubQuestions = questions
                .filter(q => q.is_post_group && q.post_group_questions)
                .flatMap(q => q.post_group_questions);
            
            // Filter out group titles themselves from this flat list
            return [...questions.filter(q => !q.is_post_group), ...postGroupSubQuestions, ...dynamicFields];
        }

        function triggerIdFromConfig(config) {
            return config.trigger_id || config.container_id_prefix.replace('dynamic-', '');
        }

        function createAdminActionButtons(questionId, currentIndex, totalItems, sourceArray, deleteHandler, editHandler, moveHandler) {
            const container = document.createElement('div');
            container.className = 'action-buttons-container';
            
            const moveUpButton = document.createElement('button');
            moveUpButton.type = 'button'; 
            moveUpButton.className = 'action-button move'; 
            moveUpButton.textContent = '⬆️'; 
            moveUpButton.title = 'Move Up';
            moveUpButton.disabled = currentIndex <= 0; // Use <= 0 for safety
            moveUpButton.addEventListener('click', (e) => { 
                e.preventDefault(); 
                moveHandler(questionId, 'up', sourceArray); 
            });
            
            const moveDownButton = document.createElement('button');
            moveDownButton.type = 'button'; 
            moveDownButton.className = 'action-button move'; 
            moveDownButton.textContent = '⬇️'; 
            moveDownButton.title = 'Move Down';
            moveDownButton.disabled = currentIndex >= totalItems - 1; // Use >= for safety
            moveDownButton.addEventListener('click', (e) => { 
                e.preventDefault(); 
                moveHandler(questionId, 'down', sourceArray); 
            });
            
            const editButton = document.createElement('button');
            editButton.type = 'button'; 
            editButton.className = 'action-button edit'; 
            editButton.innerHTML = '✏️<span style="font-size:0.9em;margin-left:2px;">Edit</span>'; 
            editButton.title = 'Edit';
            editButton.addEventListener('click', (e) => { 
                e.preventDefault(); 
                editHandler(questionId); 
            });
            
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button'; 
            deleteButton.className = 'action-button delete'; 
            deleteButton.innerHTML = '🗑️<span style="font-size:0.9em;margin-left:2px;">Del</span>'; 
            deleteButton.title = 'Delete';
            deleteButton.addEventListener('click', (e) => { 
                e.preventDefault(); 
                deleteHandler(questionId); 
            });
            
            container.appendChild(moveUpButton); 
            container.appendChild(moveDownButton); 
            container.appendChild(editButton); 
            container.appendChild(deleteButton);
            
            return container;
        }

        function handleDeleteQuestion(id) {
            const questionIndex = questions.findIndex(q => q.id === id);
            let questionText = `Question with ID ${id}`; // Fallback text

            // Find the question in main list or post groups to get text
            const mainQuestion = questions.find(q => q.id === id);
            let subQuestionParent = null;
            let subQuestionIndex = -1;

            if (mainQuestion) {
                questionText = mainQuestion.question_text;
            } else {
                questions.forEach(group => {
                    if (group.is_post_group && group.post_group_questions) {
                        const idx = group.post_group_questions.findIndex(subQ => subQ.id === id);
                        if (idx !== -1) {
                            questionText = group.post_group_questions[idx].question_text;
                            subQuestionParent = group;
                            subQuestionIndex = idx;
                        }
                    }
                });
            }

            if (confirm(`Are you sure you want to delete: "${questionText}"?`)) {
                if (mainQuestion) {
                    questions.splice(questionIndex, 1);
                } else if (subQuestionParent && subQuestionIndex !== -1) {
                    subQuestionParent.post_group_questions.splice(subQuestionIndex, 1);
                } else {
                    console.error(`Could not find question ${id} to delete.`);
                    return; // Don't proceed if not found
                }

                delete answers[id];
                // Cleanup dynamic fields/answers if it was a trigger question
                const dynamicConfig = initialChainlinkFenceQuestions.find(q => q.id === id)?.dynamic_fields;
                if (dynamicConfig) {
                    // Clear structures and answers
                    if (dynamicConfig.type === 'gate') {
                        dynamicFieldStructures[`${dynamicConfig.gate_type}Gates`] = [];
                        cleanupOrphanedAnswers(id, 0); // Remove related answers
                    } else { // pulls
                        dynamicFieldStructures.pulls = [];
                        cleanupOrphanedAnswers(id, 0); // Remove related answers
                    }
                }

                console.log(`Deleted question: ${id}`);
                renderForm(); // Re-render
            }
        }

        function handleMoveQuestion(itemId, direction, sourceArray) {
            const currentIndex = sourceArray.findIndex(q => q.id === itemId);
            if (currentIndex === -1) return;
            const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (targetIndex < 0 || targetIndex >= sourceArray.length) return;

            const itemToMove = sourceArray[currentIndex];
            const itemToSwapWith = sourceArray[targetIndex];
            itemToMove.order = itemToMove.order ?? 9999;
            itemToSwapWith.order = itemToSwapWith.order ?? 9999;

            const tempOrder = itemToMove.order;
            itemToMove.order = itemToSwapWith.order;
            itemToSwapWith.order = tempOrder;
            renderForm();
        }

        function handleEditQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) {
                console.error(`Could not find question ${questionId} to edit.`);
                return;
            }

            editingQuestionId = questionId;
            document.getElementById('newQuestionId').value = question.id;
            document.getElementById('newQuestionText').value = question.question_text;
            document.getElementById('newQuestionInputType').value = question.input_type;
            document.getElementById('newQuestionSection').value = question.section;
            document.getElementById('newQuestionDefault').value = question.default || '';
            document.getElementById('newQuestionRequired').checked = question.required;
            document.getElementById('newQuestionCalculated').checked = question.calculated;
            document.getElementById('newQuestionDependentOn').value = question.dependent_on || '';
            document.getElementById('newQuestionDependentValue').value = question.dependent_value || '';
            document.getElementById('newQuestionOrder').value = question.order;
            document.getElementById('newQuestionOptions').value = question.options ? question.options.join(', ') : '';

            toggleAddQuestionFormUI(true);
        }
    </script>
</body>
</html>